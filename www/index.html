<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Orion (Material You)</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<!-- Tailwind CSS -->
<script src="/tw.js"></script>
<!-- Chart.js -->
<script src="lib/chart.js"></script>
<!-- Marked.js -->
<script src="lib/marked.min.js"></script>
<!-- Icons -->
<link rel="stylesheet" href="css/all.min.css">
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
fontFamily: {
sans: ['"Plus Jakarta Sans"', 'sans-serif'],
display: ['"Outfit"', 'sans-serif'],
mono: ['"JetBrains Mono"', 'monospace'],
},
colors: {
md: {
sys: {
color: {
background: '#0F0E13',
onBackground: '#E6E1E5',
surface: '#141218',
surfaceContainerLow: '#1D1B20',
surfaceContainer: '#211F26',
surfaceContainerHigh: '#2B2930',
surfaceContainerHighest: '#36343B',
onSurface: '#E6E1E5',
onSurfaceVariant: '#CAC4D0',
outline: '#938F99',
outlineVariant: '#49454F',
primary: '#D0BCFF',
onPrimary: '#381E72',
primaryContainer: '#4F378B',
onPrimaryContainer: '#EADDFF',
secondary: '#CCC2DC',
onSecondary: '#332D41',
secondaryContainer: '#4A4458',
onSecondaryContainer: '#E8DEF8',
tertiary: '#EFB8C8',
onTertiary: '#492532',
tertiaryContainer: '#633B48',
onTertiaryContainer: '#FFD8E4',
error: '#F2B8B5',
onError: '#601410',
errorContainer: '#8C1D18',
onErrorContainer: '#F9DEDC',
}
}
}
},
borderRadius: {
'xs': '4px',
'sm': '8px',
'md': '12px',
'lg': '16px',
'xl': '24px',
'2xl': '32px',
'3xl': '48px',
'4xl': '56px',
},
boxShadow: {
'elevation-1': '0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15)',
'elevation-2': '0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15)',
'elevation-3': '0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3)',
'glow': '0 0 20px -5px rgba(208, 188, 255, 0.3)',
},
animation: {
'fade-in': 'fadeIn 0.5s cubic-bezier(0.2, 0.0, 0, 1.0)',
'slide-up': 'slideUp 0.6s cubic-bezier(0.2, 0.0, 0, 1.0)',
'scale-in': 'scaleIn 0.4s cubic-bezier(0.2, 0.0, 0, 1.0)',
'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
},
keyframes: {
fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
}
}
}
}
</script>
<style>
body {
  -webkit-tap-highlight-color: transparent;
  background-color: #0F0E13;
  /* Prevent default zoom on iOS input focus */
  font-size: 16px;
}
/* Custom Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #49454F; border-radius: 9999px; }
::-webkit-scrollbar-thumb:hover { background: #79747E; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
/* Ripple Effect */
.ripple {
  position: relative;
  overflow: hidden;
  transform: translate3d(0, 0, 0);
}
.ripple:after {
  content: "";
  display: block;
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  pointer-events: none;
  background-image: radial-gradient(circle, rgba(208, 188, 255, 0.15) 10%, transparent 10.01%);
  background-repeat: no-repeat;
  background-position: 50%;
  transform: scale(10, 10);
  opacity: 0;
  transition: transform .5s, opacity 1s;
}
.ripple:active:after {
  transform: scale(0, 0);
  opacity: 0.2;
  transition: 0s;
}
/* Typing Animation */
.typing-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #D0BCFF;
  animation: typing 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
/* Mobile Overlay */
#mobile-overlay { backdrop-filter: blur(4px); }
#mobile-overlay.open { opacity: 1; pointer-events: auto; }
#sidebar.mobile-open { transform: translateX(0); }

/* Typography Override for Markdown */
.prose h1, .prose h2, .prose h3 {
  font-family: 'Outfit', sans-serif;
  letter-spacing: -0.02em;
}

/* ✅ CHAT STREAM BOTTOM PADDING (RESPECTS INPUT DOCK) */
#chat-stream {
  padding-bottom: calc(10rem + env(safe-area-inset-bottom));
}
@media (max-height: 700px) {
  #chat-stream {
    padding-bottom: calc(14rem + env(safe-area-inset-bottom));
  }
}
@media (max-height: 500px) {
  #chat-stream {
    padding-bottom: calc(18rem + env(safe-area-inset-bottom));
  }
}

/* ✅ KEYBOARD OPEN STATE */
.keyboard-open #input-dock {
  transform: translateY(-10px);
}
@media (max-width: 768px) {
  .keyboard-open main {
    margin-bottom: 8rem;
  }
  .keyboard-open input,
  .keyboard-open textarea {
    font-size: 16px !important;
  }
}
</style>
</head>
<body class="text-md-sys-color-onBackground h-screen w-full flex overflow-hidden font-sans selection:bg-md-sys-color-primaryContainer selection:text-md-sys-color-onPrimaryContainer">
<!-- MOBILE OVERLAY -->
<div id="mobile-overlay" onclick="toggleMobileSidebar()" class="md:hidden fixed inset-0 bg-black/60 z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>

<!-- NAVIGATION DRAWER -->
<nav id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-md-sys-color-surfaceContainerLow md:bg-transparent flex flex-col z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.2,0,0,1)]">
<div class="h-full md:m-3 md:rounded-3xl md:bg-md-sys-color-surfaceContainerLow flex flex-col overflow-hidden shadow-elevation-1 md:border border-md-sys-color-outlineVariant/20">
  <!-- Header: FAB -->
  <div class="p-4 pb-2">
    <button onclick="startNewChat()" class="ripple w-full h-16 flex items-center gap-4 px-6 bg-md-sys-color-primaryContainer text-md-sys-color-onPrimaryContainer hover:shadow-glow hover:brightness-110 rounded-2xl transition-all duration-300 group">
      <i class="fa-solid fa-plus text-xl"></i>
      <span class="text-base font-semibold tracking-wide">New chat</span>
    </button>
    <button onclick="toggleMobileSidebar()" class="md:hidden absolute top-6 right-4 text-md-sys-color-onSurfaceVariant p-2">
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>
  </div>
  <div class="px-6 py-4">
    <span class="text-xs font-bold text-md-sys-color-primary tracking-wider uppercase opacity-80">Recent Activity</span>
  </div>
  <div id="history-list" class="flex-1 overflow-y-auto px-3 space-y-1 pb-4"></div>
  <div class="p-4 mt-auto border-t border-md-sys-color-outlineVariant/20 bg-md-sys-color-surfaceContainerLow">
    <button onclick="clearChats()" class="w-full flex items-center gap-4 px-4 py-3 rounded-full hover:bg-md-sys-color-surfaceContainerHigh transition-colors text-left group ripple">
      <i class="fa-regular fa-trash-can text-md-sys-color-onSurfaceVariant group-hover:text-md-sys-color-error transition-colors"></i>
      <div class="text-sm font-medium text-md-sys-color-onSurfaceVariant group-hover:text-md-sys-color-error">Clear all history</div>
    </button>
  </div>
</div>
</nav>

<!-- MAIN SURFACE -->
<main class="flex-1 flex flex-col relative min-w-0">
  <!-- TOP APP BAR -->
  <header class="h-20 flex items-center justify-between px-6 sticky top-0 z-20 bg-md-sys-color-background/80 backdrop-blur-md">
    <div class="flex items-center gap-4">
      <button onclick="toggleMobileSidebar()" class="md:hidden text-md-sys-color-onSurfaceVariant ripple p-2 rounded-full">
        <i class="fa-solid fa-bars text-xl"></i>
      </button>
      <div class="relative group">
        <button id="model-dropdown-button" class="flex items-center gap-3 pl-1 pr-3 py-1.5 rounded-xl hover:bg-md-sys-color-surfaceContainerHigh transition-all border border-transparent hover:border-md-sys-color-outlineVariant/30" aria-haspopup="true">
          <div class="w-8 h-8 rounded-lg bg-md-sys-color-primaryContainer flex items-center justify-center text-md-sys-color-onPrimaryContainer">
            <i class="fa-solid fa-sparkles text-sm"></i>
          </div>
          <div class="flex flex-col items-start">
            <span class="text-xs text-md-sys-color-onSurfaceVariant font-medium">Model</span>
            <span id="current-model-display" class="text-sm font-semibold text-md-sys-color-onSurface leading-none mt-0.5">Loading...</span>
          </div>
          <i class="fa-solid fa-chevron-down text-xs text-md-sys-color-onSurfaceVariant ml-2"></i>
        </button>
        <div id="model-dropdown-menu" class="absolute left-0 top-full mt-2 w-72 rounded-2xl shadow-elevation-3 bg-md-sys-color-surfaceContainerHigh ring-1 ring-white/5 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-out z-50 p-2 transform origin-top-left scale-95 group-hover:scale-100">
          <div class="py-1 space-y-1 max-h-[60vh] overflow-y-auto custom-scrollbar" id="model-options-container"></div>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div id="agent-status-badge" class="hidden md:flex items-center gap-2 px-4 py-1.5 rounded-full bg-md-sys-color-surfaceContainerHigh border border-md-sys-color-outlineVariant/30">
        <div class="w-2 h-2 rounded-full bg-md-sys-color-outline"></div>
        <span class="text-xs font-medium text-md-sys-color-onSurfaceVariant tracking-wide">READY</span>
      </div>
      <button onclick="toggleCanvas()" id="btn-toggle-canvas" class="w-12 h-12 rounded-full flex items-center justify-center text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHigh hover:text-md-sys-color-primary transition-all ripple">
        <i class="fa-solid fa-code text-lg"></i>
      </button>
    </div>
  </header>

  <!-- WELCOME VIEW -->
  <div id="view-welcome" class="flex-1 flex flex-col items-center justify-center p-6 animate-fade-in pb-32">
    <div class="text-center mb-10 space-y-2">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-[32px] bg-gradient-to-br from-md-sys-color-primaryContainer to-md-sys-color-tertiaryContainer mb-6 shadow-glow">
        <i class="fa-solid fa-atom text-4xl text-white"></i>
      </div>
      <h1 class="text-4xl md:text-5xl font-display font-medium text-md-sys-color-onSurface tracking-tight">
        Hello, <span class="text-transparent bg-clip-text bg-gradient-to-r from-md-sys-color-primary to-md-sys-color-tertiary">Creator</span>
      </h1>
      <p class="text-lg text-md-sys-color-onSurfaceVariant font-light">What shall we build together today?</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-3xl">
      <button onclick="fillInput('Scan current directory for unused files')" class="group relative p-5 rounded-3xl bg-md-sys-color-surfaceContainerLow hover:bg-md-sys-color-surfaceContainerHigh transition-all duration-300 text-left overflow-hidden border border-transparent hover:border-md-sys-color-outlineVariant/30">
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex justify-between items-start mb-2">
            <span class="w-10 h-10 rounded-full bg-md-sys-color-secondaryContainer text-md-sys-color-onSecondaryContainer flex items-center justify-center group-hover:scale-110 transition-transform">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
            <i class="fa-solid fa-arrow-up-right text-md-sys-color-onSurfaceVariant opacity-0 group-hover:opacity-100 transition-opacity"></i>
          </div>
          <h3 class="text-base font-semibold text-md-sys-color-onSurface mb-1">Audit Files</h3>
          <p class="text-sm text-md-sys-color-onSurfaceVariant font-light">Scan directory for unused assets</p>
        </div>
      </button>
      <!-- Other suggestion cards omitted for brevity but remain unchanged -->
      <button onclick="fillInput('Create a Python script to visualize sales.csv')" class="group relative p-5 rounded-3xl bg-md-sys-color-surfaceContainerLow hover:bg-md-sys-color-surfaceContainerHigh transition-all duration-300 text-left overflow-hidden border border-transparent hover:border-md-sys-color-outlineVariant/30">
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex justify-between items-start mb-2">
            <span class="w-10 h-10 rounded-full bg-md-sys-color-tertiaryContainer text-md-sys-color-onTertiaryContainer flex items-center justify-center group-hover:scale-110 transition-transform">
              <i class="fa-solid fa-chart-pie"></i>
            </span>
            <i class="fa-solid fa-arrow-up-right text-md-sys-color-onSurfaceVariant opacity-0 group-hover:opacity-100 transition-opacity"></i>
          </div>
          <h3 class="text-base font-semibold text-md-sys-color-onSurface mb-1">Data Viz</h3>
          <p class="text-sm text-md-sys-color-onSurfaceVariant font-light">Plot charts from local CSV data</p>
        </div>
      </button>
    </div>
  </div>

  <!-- CHAT VIEW -->
  <div id="view-chat" class="flex-1 flex flex-col overflow-hidden hidden">
    <div id="chat-stream" class="flex-1 overflow-y-auto p-4 md:px-20 md:py-8 space-y-10 scroll-smooth pb-40 w-full max-w-6xl mx-auto">
      <!-- Messages injected via JS -->
    </div>
  </div>

  <!-- INPUT DOCK -->
  <div id="input-dock" class="absolute bottom-6 left-0 right-0 px-4 z-30 pointer-events-none">
    <div class="max-w-4xl mx-auto relative pointer-events-auto">
      <div class="bg-md-sys-color-surfaceContainerHigh rounded-[36px] shadow-elevation-3 flex flex-col border border-md-sys-color-outlineVariant/20 transition-all focus-within:ring-2 focus-within:ring-md-sys-color-primary/50">
        <textarea
          id="user-input"
          rows="1"
          class="w-full bg-transparent text-md-sys-color-onSurface placeholder-md-sys-color-onSurfaceVariant/50 text-lg px-6 py-5 max-h-48 focus:outline-none resize-none no-scrollbar font-sans"
          placeholder="Type a message..."
          onkeydown="handleKeydown(event)"
          oninput="autoResize(this)"></textarea>
        <div class="flex justify-between items-center px-4 pb-3">
          <div class="flex gap-2">
            <button class="w-10 h-10 rounded-full text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHighest hover:text-md-sys-color-onSurface transition-colors ripple flex items-center justify-center">
              <i class="fa-solid fa-paperclip text-lg"></i>
            </button>
            <button class="w-10 h-10 rounded-full text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHighest hover:text-md-sys-color-onSurface transition-colors ripple flex items-center justify-center">
              <i class="fa-solid fa-microphone text-lg"></i>
            </button>
          </div>
          <button onclick="sendMessage()" id="send-btn" class="w-12 h-12 rounded-full bg-md-sys-color-primary text-md-sys-color-onPrimary hover:shadow-glow transition-all flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed ripple transform active:scale-90 duration-200">
            <i class="fa-solid fa-arrow-up text-xl"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- CODE EDITOR SIDE SHEET -->
<aside id="canvas-panel" class="w-0 border-l border-md-sys-color-outlineVariant/20 bg-md-sys-color-surfaceContainerLow flex flex-col transition-all duration-400 ease-[cubic-bezier(0.2,0,0,1)] overflow-hidden shrink-0 fixed inset-y-0 right-0 z-40 md:relative md:inset-auto shadow-elevation-2">
  <div class="h-20 flex items-center justify-between px-6 bg-md-sys-color-surfaceContainerLow/50 backdrop-blur-sm">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-md-sys-color-secondaryContainer flex items-center justify-center text-md-sys-color-onSecondaryContainer">
        <i class="fa-solid fa-file-code"></i>
      </div>
      <div>
        <h2 class="font-display font-medium text-md-sys-color-onSurface">Canvas</h2>
        <p class="text-xs text-md-sys-color-onSurfaceVariant">Generated Output</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="toggleCanvas()" class="w-10 h-10 rounded-full flex items-center justify-center text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHigh transition-colors ripple">
        <i class="fa-solid fa-xmark text-lg"></i>
      </button>
    </div>
  </div>
  <div class="flex-1 overflow-auto bg-[#13111A] p-6 font-mono text-sm leading-relaxed custom-scrollbar">
    <pre class="text-md-sys-color-onSurface"><code id="code-content"></code></pre>
    <div id="chart-container" class="hidden mt-6 bg-md-sys-color-surfaceContainer p-6 rounded-3xl border border-md-sys-color-outlineVariant/30">
      <canvas id="myChart"></canvas>
    </div>
  </div>
  <div class="p-6 bg-md-sys-color-surfaceContainerLow flex justify-end gap-3">
    <button class="px-6 py-2.5 text-sm font-medium text-md-sys-color-primary border border-md-sys-color-primary/30 rounded-full hover:bg-md-sys-color-primary/10 transition-colors">Copy</button>
    <button class="px-6 py-2.5 text-sm font-medium bg-md-sys-color-primary text-md-sys-color-onPrimary rounded-full hover:shadow-lg transition-all shadow-md">
      <i class="fa-solid fa-play mr-2 text-xs"></i>Run Code
    </button>
  </div>
</aside>

<script>
// --- PRESERVED LOGIC + ENHANCEMENTS ---
let isCanvasOpen = false;
let current_session_id = null;
let selected_model = "cognitivecomputations/dolphin-mistral-24b-venice-edition:free";
let last_user_prompt = "";
let running_commands = {};

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function handleKeydown(e) {
  if (e.key === 'Enter') {
    if (e.altKey || e.shiftKey) return;
    e.preventDefault();
    sendMessage();
  }
}

function fillInput(text) {
  const input = document.getElementById('user-input');
  input.value = text;
  autoResize(input);
  input.focus();
}

function toggleMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobile-overlay');
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('open');
}

function startNewChat() {
  current_session_id = null;
  document.getElementById('view-welcome').classList.remove('hidden');
  document.getElementById('view-chat').classList.add('hidden');
  document.getElementById('chat-stream').innerHTML = '';
  document.getElementById('user-input').value = '';
  if (isCanvasOpen) toggleCanvas();
  const sidebar = document.getElementById('sidebar');
  if (sidebar.classList.contains('mobile-open')) toggleMobileSidebar();
}

function toggleCanvas() {
  const canvas = document.getElementById('canvas-panel');
  const btn = document.getElementById('btn-toggle-canvas');
  isCanvasOpen = !isCanvasOpen;
  if (isCanvasOpen) {
    canvas.classList.remove('w-0');
    canvas.classList.add('w-[50%]');
    btn.classList.add('bg-md-sys-color-secondaryContainer', 'text-md-sys-color-onSecondaryContainer');
    btn.classList.remove('text-md-sys-color-onSurfaceVariant');
  } else {
    canvas.classList.remove('w-[50%]');
    canvas.classList.add('w-0');
    btn.classList.remove('bg-md-sys-color-secondaryContainer', 'text-md-sys-color-onSecondaryContainer');
    btn.classList.add('text-md-sys-color-onSurfaceVariant');
  }
}

async function clearChats() {
  if (confirm("Are you sure you want to clear all chat history?")) {
    await fetch('/api/clear_chats');
    getChats();
    startNewChat();
  }
}

function updateStatus(status, text) {
  const badge = document.getElementById('agent-status-badge');
  const dot = badge.querySelector('div:first-child');
  const label = badge.querySelector('span');
  const statuses = {
    idle: { color: 'bg-md-sys-color-outline', pulse: false },
    thinking: { color: 'bg-md-sys-color-primary', pulse: true },
    executing: { color: 'bg-md-sys-color-tertiary', pulse: true },
  };
  const newStatus = statuses[status] || statuses.idle;
  dot.className = `w-2 h-2 rounded-full ${newStatus.color}`;
  if (newStatus.pulse) dot.classList.add('animate-pulse'); else dot.classList.remove('animate-pulse');
  label.textContent = text.toUpperCase();
}

// ✅ IMPROVED SCROLLING
function scrollToBottom(smooth = false) {
  const stream = document.getElementById('chat-stream');
  if (!stream) return;
  if (smooth) {
    stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
  } else {
    stream.scrollTop = stream.scrollHeight;
  }
}

function appendMessage(role, text, isExecuting = false) {
  const stream = document.getElementById('chat-stream');
  const div = document.createElement('div');
  if (role === 'user') {
    div.className = 'flex justify-end animate-slide-up';
    div.innerHTML = `
      <div class="bg-md-sys-color-primary text-md-sys-color-onPrimary px-6 py-4 rounded-[28px] rounded-tr-sm max-w-[90%] md:max-w-[70%] leading-relaxed shadow-sm font-sans text-[16px]">
        ${marked.parse(text)}
      </div>
    `;
  } else {
    div.className = 'flex justify-start gap-4 animate-slide-up';
    let content = isExecuting ? text : marked.parse(text);
    const execRegex = /\[exec\]([\s\S]*?)\[\/exec\]/g;
    content = content.replace(execRegex, (match, command) => {
      const commandId = `exec-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const escapedCommand = command.replace(/'/g, "\\'").replace(/"/g, '\\"');
      return `
        <div id="${commandId}" class="mt-4 mb-2 p-1 bg-md-sys-color-surfaceContainerHigh rounded-3xl border border-md-sys-color-outlineVariant/30 overflow-hidden">
          <div class="bg-black/40 rounded-[20px] p-4 font-mono text-sm text-md-sys-color-onSurfaceVariant border-l-4 border-md-sys-color-tertiary">
            <code class="break-all">${escapedCommand}</code>
          </div>
          <div class="flex gap-2 p-2">
            <button onclick="acceptExec('${commandId}', '${escapedCommand}')" class="flex-1 py-3 bg-md-sys-color-tertiary text-md-sys-color-onTertiary rounded-full font-bold text-sm hover:shadow-lg transition-all">Execute</button>
            <button onclick="declineExec('${commandId}')" class="flex-1 py-3 text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHighest rounded-full font-medium text-sm transition-colors">Dismiss</button>
          </div>
        </div>
      `;
    });
    div.innerHTML = `
      <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-md-sys-color-primaryContainer to-md-sys-color-secondaryContainer flex-shrink-0 flex items-center justify-center mt-1 shadow-inner">
        <i class="fa-solid fa-sparkles text-md-sys-color-onPrimaryContainer text-sm"></i>
      </div>
      <div class="space-y-2 max-w-[90%] md:max-w-[85%]">
        <div class="text-xs text-md-sys-color-onSurfaceVariant font-bold ml-2 tracking-wide">ORION</div>
        <div class="text-md-sys-color-onSurface leading-relaxed prose prose-invert max-w-none bg-md-sys-color-surfaceContainer p-6 rounded-[28px] rounded-tl-sm shadow-sm border border-md-sys-color-outlineVariant/10">
          ${content}
        </div>
      </div>
    `;
  }
  stream.appendChild(div);

  // ✅ SMART AUTO-SCROLL
  const isAtBottom = stream.scrollHeight - stream.scrollTop - stream.clientHeight < 100;
  if (isAtBottom) {
    setTimeout(() => scrollToBottom(true), 50);
  }
}

// Rest of functions unchanged (acceptExec, declineExec, pollExecLog, killExec, sendMessage, retryLastPrompt, getVersion, getModels, getChats, loadChat)

async function acceptExec(blockId, command) {
  const block = document.getElementById(blockId);
  block.innerHTML = `
    <div class="p-6 flex items-center justify-center gap-4">
      <div class="flex space-x-1">
        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
      </div>
      <span class="text-sm font-medium text-md-sys-color-tertiary">Initializing...</span>
    </div>`;
  updateStatus('executing', 'Running...');
  const response = await fetch('/api/exec', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ command: command })
  });
  const result = await response.json();
  if (result.error) {
    block.innerHTML = `<div class="p-4 bg-md-sys-color-errorContainer text-md-sys-color-onErrorContainer rounded-2xl mx-2 mb-2">Error: ${result.error}</div>`;
    updateStatus('idle', 'Idle');
    return;
  }
  const command_id = result.command_id;
  block.innerHTML = `
    <div class="bg-[#13111A] rounded-[24px] m-1 overflow-hidden">
      <div class="flex items-center justify-between p-3 border-b border-white/10 bg-md-sys-color-surfaceContainer">
        <span class="text-xs font-bold text-md-sys-color-tertiary animate-pulse px-2">● RUNNING</span>
        <button onclick="killExec('${command_id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-md-sys-color-errorContainer text-md-sys-color-onErrorContainer hover:opacity-80 transition-opacity"><i class="fa-solid fa-stop text-xs"></i></button>
      </div>
      <pre class="p-4 text-xs text-md-sys-color-onSurfaceVariant font-mono max-h-64 overflow-auto custom-scrollbar" id="log-${command_id}"></pre>
    </div>
  `;
  running_commands[command_id] = setInterval(() => pollExecLog(command_id), 1000);
}

function declineExec(blockId) {
  const block = document.getElementById(blockId);
  block.innerHTML = `<div class="p-4 text-center text-xs text-md-sys-color-outline italic">Action cancelled</div>`;
}

async function pollExecLog(command_id) {
  const response = await fetch(`/api/exec_log?command_id=${command_id}`);
  const result = await response.json();
  const logEl = document.getElementById(`log-${command_id}`);
  if (logEl) logEl.textContent = result.log;
  if (result.status === "finished") {
    clearInterval(running_commands[command_id]);
    delete running_commands[command_id];
    const parent = logEl.parentElement;
    const header = parent.querySelector('div:first-child');
    header.querySelector('span').textContent = '✓ COMPLETE';
    header.querySelector('span').className = 'text-xs font-bold text-md-sys-color-primary px-2';
    const btn = header.querySelector('button');
    if (btn) btn.remove();
    updateStatus('idle', 'Idle');
  }
}

async function killExec(command_id) {
  clearInterval(running_commands[command_id]);
  delete running_commands[command_id];
  await fetch('/api/exec_kill', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ command_id: command_id })
  });
  const block = document.getElementById(`log-${command_id}`).parentElement;
  const header = block.querySelector('div:first-child');
  header.querySelector('span').textContent = '⚠ KILLED';
  header.querySelector('span').className = 'text-xs font-bold text-md-sys-color-error px-2';
  const btn = header.querySelector('button');
  if (btn) btn.remove();
  updateStatus('idle', 'Idle');
}

async function sendMessage(prompt = null, isFollowUp = false) {
  const input = document.getElementById('user-input');
  const text = prompt || input.value.trim();
  if (!text) return;
  if (!isFollowUp) {
    last_user_prompt = text;
    appendMessage('user', text);
  }
  document.getElementById('view-welcome').classList.add('hidden');
  document.getElementById('view-chat').classList.remove('hidden');
  input.value = '';
  input.style.height = 'auto';
  document.getElementById('send-btn').disabled = true;
  updateStatus('thinking', 'Thinking...');
  const response = await fetch('/api/prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: text, session_id: current_session_id, model: selected_model })
  });
  const result = await response.json();
  updateStatus('idle', 'Idle');
  document.getElementById('send-btn').disabled = false;
  if (!current_session_id && result.session_id) {
    getChats();
  }
  current_session_id = result.session_id;
  if (result.error) {
    appendMessage('bot', `**Error:** ${result.error} <button onclick="retryLastPrompt()" class="ml-2 px-2 py-1 bg-red-600/80 text-white rounded text-xs"><i class="fa-solid fa-rotate-right"></i> Retry</button>`, true);
    return;
  }
  let botResponse = result.response;
  const canvasRegex = /\[canvas\]([\s\S]*?)\[\/canvas\]/;
  const canvasMatch = botResponse.match(canvasRegex);
  if (canvasMatch) {
    const canvasContent = canvasMatch[1];
    document.getElementById('code-content').textContent = canvasContent;
    if (!isCanvasOpen) {
      toggleCanvas();
    }
    botResponse = botResponse.replace(canvasRegex, '').trim();
  }
  if (botResponse) {
    appendMessage('bot', botResponse);
  }
}

function retryLastPrompt() {
  if (last_user_prompt) {
    const stream = document.getElementById('chat-stream');
    stream.removeChild(stream.lastChild);
    sendMessage(last_user_prompt, true);
  }
}

async function getVersion() {
  const response = await fetch('/api/version');
  const data = await response.json();
}

async function getModels() {
  const response = await fetch('/api/models');
  const models = await response.json();
  const modelOptionsContainer = document.getElementById('model-options-container');
  const currentModelDisplay = document.getElementById('current-model-display');
  modelOptionsContainer.innerHTML = '';
  models.forEach(model => {
    const button = document.createElement('button');
    button.className = 'w-full text-left px-4 py-3 text-sm text-md-sys-color-onSurfaceVariant hover:bg-md-sys-color-surfaceContainerHighest hover:text-md-sys-color-onSurface transition-colors rounded-xl flex items-center gap-3 group';
    button.setAttribute('role', 'menuitem');
    const modelName = model.split('/').pop().replace(':free', '');
    button.innerHTML = `
      <div class="w-1 h-1 rounded-full bg-md-sys-color-outline group-hover:bg-md-sys-color-primary transition-colors"></div>
      <span class="truncate">${modelName}</span>
    `;
    button.onclick = () => {
      selected_model = model;
      currentModelDisplay.textContent = modelName;
    };
    modelOptionsContainer.appendChild(button);
  });
  currentModelDisplay.textContent = selected_model.split('/').pop().replace(':free', '');
}

async function getChats() {
  const response = await fetch('/api/chats');
  const data = await response.json();
  const historyList = document.getElementById('history-list');
  historyList.innerHTML = '';
  data.reverse().forEach(chat => {
    const button = document.createElement('button');
    button.className = 'w-full text-left px-6 py-4 rounded-full text-sm font-medium truncate transition-all flex items-center gap-4 mb-1 border border-transparent';
    const isActive = chat.id === current_session_id;
    if (isActive) {
      button.classList.add('bg-md-sys-color-secondaryContainer', 'text-md-sys-color-onSecondaryContainer');
    } else {
      button.classList.add('text-md-sys-color-onSurfaceVariant', 'hover:bg-md-sys-color-surfaceContainerHigh');
    }
    button.innerHTML = `
      <i class="fa-regular fa-message ${isActive ? 'text-md-sys-color-onSecondaryContainer' : 'text-md-sys-color-outline'}"></i>
      <span class="truncate">${chat.name}</span>
    `;
    button.onclick = () => {
      if (chat.id === current_session_id) return;
      loadChat(chat.id);
      if (document.getElementById('sidebar').classList.contains('mobile-open')) {
        toggleMobileSidebar();
      }
    };
    historyList.appendChild(button);
  });
}

async function loadChat(session_id) {
  current_session_id = session_id;
  getChats();
  const response = await fetch(`/api/history?session_id=${session_id}`);
  const data = await response.json();
  const stream = document.getElementById('chat-stream');
  stream.innerHTML = '';
  document.getElementById('view-welcome').classList.add('hidden');
  document.getElementById('view-chat').classList.remove('hidden');
  data.forEach(entry => {
    appendMessage('user', entry.user);
    const containsExec = /\[exec\]([\s\S]*?)\[\/exec\]/g.test(entry.bot);
    appendMessage('bot', entry.bot, containsExec);
  });
  stream.scrollTop = stream.scrollHeight;
}

// ✅ MOBILE KEYBOARD HANDLING
function setupMobileKeyboardHandling() {
  const input = document.getElementById('user-input');
  let keyboardOpen = false;

  input.addEventListener('focus', () => {
    setTimeout(() => {
      if (window.visualViewport) {
        if (window.visualViewport.height < window.innerHeight * 0.7) {
          document.body.classList.add('keyboard-open');
          keyboardOpen = true;
        }
      }
      scrollToBottom(true);
    }, 300);
  });

  input.addEventListener('blur', () => {
    setTimeout(() => {
      if (document.activeElement === document.body && keyboardOpen) {
        document.body.classList.remove('keyboard-open');
        keyboardOpen = false;
      }
    }, 200);
  });

  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
      if (window.visualViewport.height < window.innerHeight * 0.7) {
        if (!keyboardOpen) {
          document.body.classList.add('keyboard-open');
          keyboardOpen = true;
          scrollToBottom(true);
        }
      } else {
        if (keyboardOpen) {
          document.body.classList.remove('keyboard-open');
          keyboardOpen = false;
        }
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  getVersion();
  getModels();
  getChats();
  updateStatus('idle', 'Idle');
  document.getElementById('send-btn').disabled = false;
  setupMobileKeyboardHandling();
});
</script>
</body>
</html>